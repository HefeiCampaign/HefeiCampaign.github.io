<!DOCTYPE html>
<html lang="zh-tw">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Beacon OF Love｜最即時的愛滋資訊整合網站 - 我要篩檢 - 篩檢試劑
    </title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
      integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      .popup-title {
        font-weight: 700;
        margin-bottom: 0.25rem;
      }
      .popup-desc {
        margin: 0.15rem 0;
      }
      .popup-retrieve-time {
        font-size: 0.65rem;
        color: #999;
        font-weight: 400;
        margin-left: 8px;
      }
      .legend {
        position: absolute;
        z-index: 1000;
        bottom: 24px;
        right: 12px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        padding: 8px 10px;
        font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }
      .legend .row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0;
      }
      .legend .swatch {
        width: 12px;
        height: 20px;
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
      }
      .locate-btn {
        position: absolute;
        z-index: 1001;
        top: 80px;
        left: 12px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px 10px;
        cursor: pointer;
        font: 14px/1.2 system-ui;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .locate-btn .text {
        margin-left: 5px;
      }
      @media (max-width: 380px) {
        .locate-btn .text {
          display: none;
        }
      }
      .locate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .go-back-btn {
        position: absolute;
        z-index: 1001;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px 10px;
        cursor: pointer;
        font: 14px/1.2 system-ui;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .go-back-btn .text {
        margin-left: 5px;
      }
      @media (max-width: 566px) {
        .go-back-btn {
          top: 120px;
          left: 12px;
          transform: translateX(0%);
        }
      }
      @media (max-width: 380px) {
        .go-back-btn .text {
          display: none;
        }
      }
      .admin-panel {
        position: absolute;
        z-index: 1000;
        top: 10px;
        right: 12px;
        padding: 8px 10px;
        width: 200px;
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }
      .admin-panel .admin-panel-item:not(:last-child) {
        margin-bottom: 10px;
      }
      .admin-panel label {
        display: block;
        font-size: 12px;
        color: #333;
        margin-bottom: 4px;
      }
      .admin-panel select,
      .admin-panel input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #fff;
      }
      .admin-panel input#searchInput {
        width: calc(100% - 16px);
      }
      /* 自動完成清單樣式 */
      .search-wrap {
        position: relative;
      }
      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1001;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-top: 4px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        max-height: 280px;
        overflow: auto;
      }
      .search-item {
        padding: 8px 10px;
        cursor: pointer;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .search-item:hover,
      .search-item.active {
        background: #f5f7fa;
      }
      .badge {
        font-size: 12px;
        line-height: 1;
        padding: 3px 6px;
        border-radius: 999px;
        background: #eef2ff;
        color: #3743ac;
        border: 1px solid #dfe3ff;
        white-space: nowrap;
      }
      mark {
        background: #fff3bf;
        color: inherit;
        padding: 0 1px;
        border-radius: 2px;
      }
      .toggle ~ .details {
        display: none;
      }
      .toggle:not(.active) > .expanded,
      .toggle.active > .collapsed {
        display: none;
      }
      .toggle.active > .expanded,
      .toggle:not(.active) > .collapsed {
        display: inline;
      }
      .toggle.active ~ .details {
        display: block;
      }
      .expand-collapse-text {
        text-decoration: none;
        cursor: pointer;
        color: #333;
        user-select: none;
      }
    </style>
  </head>

  <body>
    <button
      id="goBackBtn"
      class="go-back-btn"
      type="button"
      aria-label="回上頁"
      onclick="javascript:history.back()"
    >
      ↩<span id="goBackBtnText" class="text">回到上頁</span>
    </button>
    <button
      id="locateBtn"
      class="locate-btn"
      type="button"
      aria-label="移到我的位置"
    >
      📍<span id="locateBtnText" class="text">移到我的位置</span>
    </button>

    <!-- 行政區控制面板 -->
    <div class="admin-panel" role="form" aria-label="行政區選擇">
      <span
        id="admin-panel-toggle"
        class="toggle expand-collapse-text" 
        onclick="javascript:document.querySelector('#admin-panel-toggle').classList.toggle('active')"
      >
        <span class="icon collapsed">▶</span>
        <span class="icon expanded">▼</span>
        行政區選擇
      </span>
      <div class="details">
        <div class="admin-panel-item">
          <label for="countySelect">縣市</label>
          <select id="countySelect" aria-label="選擇縣市">
            <option value="">（全部）</option>
          </select>
        </div>
        <div class="admin-panel-item">
          <label for="districtSelect">鄉鎮市區</label>
          <select id="districtSelect" aria-label="選擇鄉鎮市區" disabled>
            <option value="">（請先選縣市）</option>
          </select>
        </div>
        <div class="admin-panel-item search-wrap">
          <label for="searchInput">🔎 模糊搜尋（縣市或「縣市 區」）</label>
          <input
            id="searchInput"
            type="text"
            placeholder="例：臺北市 或 臺北市 大安區 / 大安"
            autocomplete="off"
          />
          <div
            id="searchResults"
            class="search-results"
            style="display: none"
          ></div>
        </div>
      </div>
    </div>

    <div id="map" role="region" aria-label="HIV self-tester stock map"></div>

    <!-- Legend -->
    <div class="legend" aria-hidden="true">
      <div class="row">
        <span
          class="swatch"
          style="
            background-image: url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png');
          "
        ></span>
        <span>0（缺貨）</span>
      </div>
      <div class="row">
        <span
          class="swatch"
          style="
            background-image: url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png');
          "
        ></span>
        <span>&lt; 10（低庫存）</span>
      </div>
      <div class="row">
        <span
          class="swatch"
          style="
            background-image: url('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png');
          "
        ></span>
        <span>其他（一般）</span>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"
      integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <script>
      // Base map
      const map = L.map("map", { center: [23.7, 121], zoom: 7 });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);
      L.control.scale().addTo(map);

      // Colored marker icons (via leaflet-color-markers)
      const shadowUrl =
        "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png";
      const iconBase = (color) =>
        new L.Icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
          shadowUrl,
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41],
        });

      const ICONS = {
        red: iconBase("red"),
        yellow: iconBase("yellow"),
        blue: iconBase("blue"),
      };

      // ===== UI refs =====
      const countySelect = document.getElementById("countySelect");
      const districtSelect = document.getElementById("districtSelect");
      const searchInput = document.getElementById("searchInput");
      const resultsEl = document.getElementById("searchResults");

      // ===== Data =====
      let REGIONS = [];
      const SEARCH_INDEX = []; // {type:'county'|'district', county, district?, label, labelFull, ref}

      // ===== Helpers =====
      const getCounty = (name) => REGIONS.find((c) => c.name === name) || null;
      const getDistrictBounds = (d) => {
        if (d?.boundary)
          return [
            [d.boundary.lat_min, d.boundary.lon_min],
            [d.boundary.lat_max, d.boundary.lon_max],
          ];
        const e = d?.geo_info?.candidates?.[0]?.extent;
        return e
          ? [
              [e.ymin, e.xmin],
              [e.ymax, e.xmax],
            ]
          : null;
      };
      const unionBounds = (b1, b2) =>
        !b1
          ? b2
          : !b2
          ? b1
          : [
              [Math.min(b1[0][0], b2[0][0]), Math.min(b1[0][1], b2[0][1])],
              [Math.max(b1[1][0], b2[1][0]), Math.max(b1[1][1], b2[1][1])],
            ];
      const flyToDistrict = (d) => {
        const b = getDistrictBounds(d);
        if (b) map.fitBounds(b, { padding: [20, 20] });
        else if (Array.isArray(d?.geo_point)) map.flyTo(d.geo_point, 13);
      };
      const flyToCounty = (c) => {
        let ub = null,
          center = null;
        (c?.districts || []).forEach((d) => {
          const b = getDistrictBounds(d);
          if (b) ub = unionBounds(ub, b);
          if (!center && Array.isArray(d.geo_point)) center = d.geo_point;
        });
        if (ub) map.fitBounds(ub, { padding: [24, 24] });
        else if (center) map.flyTo(center, 11);
      };

      // ===== 下拉 =====
      function fillCountyOptions() {
        countySelect.innerHTML = '<option value="">（全部）</option>';
        REGIONS.forEach((c) =>
          countySelect.appendChild(new Option(c.name, c.name))
        );
      }
      function fillDistrictOptions(cname) {
        const c = getCounty(cname);
        districtSelect.innerHTML = "";
        if (!c) {
          districtSelect.disabled = true;
          districtSelect.innerHTML = '<option value="">（請先選縣市）</option>';
          return;
        }
        districtSelect.disabled = false;
        districtSelect.appendChild(new Option("（全部）", ""));
        c.districts.forEach((d) =>
          districtSelect.appendChild(new Option(d.name, d.name))
        );
      }
      countySelect.addEventListener("change", () => {
        const c = getCounty(countySelect.value);
        fillDistrictOptions(c?.name || "");
        if (c) flyToCounty(c);
      });
      districtSelect.addEventListener("change", () => {
        const c = getCounty(countySelect.value);
        if (!c) return;
        const dname = districtSelect.value;
        if (!dname) {
          flyToCounty(c);
          return;
        }
        flyToDistrict(c.districts.find((x) => x.name === dname));
      });

      // ===== 搜尋索引 =====
      function buildSearchIndex() {
        SEARCH_INDEX.length = 0;
        // 縣市
        for (const c of REGIONS) {
          SEARCH_INDEX.push({
            type: "county",
            county: c.name,
            label: c.name,
            labelFull: c.name,
            ref: c,
          });
          // 縣市 + 區
          for (const d of c.districts || []) {
            SEARCH_INDEX.push({
              type: "district",
              county: c.name,
              district: d.name,
              label: d.name,
              labelFull: `${c.name} ${d.name}`,
              ref: d,
            });
          }
        }
      }

      // ===== 模糊搜尋 + 高亮 =====
      function escapeRegExp(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }
      function highlight(text, query) {
        if (!query) return text;
        const re = new RegExp(escapeRegExp(query), "gi");
        return text.replace(re, (m) => `<mark>${m}</mark>`);
      }

      let activeIndex = -1; // 鍵盤選取
      function renderResults(items, query) {
        resultsEl.innerHTML = "";
        activeIndex = -1;
        if (!items.length) {
          resultsEl.style.display = "none";
          return;
        }
        const frag = document.createDocumentFragment();
        items.slice(0, 30).forEach((item, idx) => {
          const div = document.createElement("div");
          div.className = "search-item";
          div.dataset.idx = String(idx);
          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = item.type === "district" ? "鄉鎮市區" : "縣市";
          const title = document.createElement("div");
          title.innerHTML = `
            <div>${highlight(item.labelFull, query)}</div>
            ${
              item.type === "district"
                ? `<div style="font-size:12px;color:#666;">${highlight(
                    item.county,
                    query
                  )}・${highlight(item.label, query)}</div>`
                : ""
            }
          `;
          div.appendChild(badge);
          div.appendChild(title);
          div.addEventListener("mousedown", (e) => {
            // 用 mousedown 可避免 blur 關閉
            e.preventDefault();
            applyResult(item);
          });
          frag.appendChild(div);
        });
        resultsEl.appendChild(frag);
        resultsEl.style.display = "block";
      }

      function applyResult(item) {
        searchInput.value = item.labelFull;
        resultsEl.style.display = "none";
        if (item.type === "county") {
          const c = getCounty(item.county);
          countySelect.value = c.name;
          fillDistrictOptions(c.name);
          flyToCounty(c);
        } else {
          const c = getCounty(item.county);
          const d = (c?.districts || []).find((x) => x.name === item.district);
          countySelect.value = c.name;
          fillDistrictOptions(c.name);
          districtSelect.value = d.name;
          flyToDistrict(d);
        }
      }

      function doSearch(q) {
        const query = q.trim();
        if (!query) {
          resultsEl.style.display = "none";
          return;
        }

        // 規則：
        // 1) 完整「縣市 區」優先完全包含
        // 2) 其次區名包含
        // 3) 其次縣市名包含
        const parts = query.split(/\s+/);
        const candidates = SEARCH_INDEX.filter((it) => {
          if (parts.length >= 2) {
            return it.labelFull.includes(query);
          }
          return (
            it.labelFull.includes(query) ||
            it.label.includes(query) ||
            (it.type === "district" && it.county.includes(query))
          );
        });

        // 排序：完整 > 區名 > 縣市名；同分按 labelFull 長度再按字典序
        const scored = candidates
          .map((it) => {
            let score = 0;
            if (it.labelFull.includes(query)) score += 3;
            if (it.type === "district" && it.label.includes(query)) score += 2;
            if (it.county?.includes(query)) score += 1;
            return { it, score };
          })
          .sort(
            (a, b) =>
              b.score - a.score ||
              a.it.labelFull.length - b.it.labelFull.length ||
              a.it.labelFull.localeCompare(b.it.labelFull)
          )
          .map((x) => x.it);

        renderResults(scored, query);
      }

      searchInput.addEventListener("input", (e) => {
        doSearch(searchInput.value);
      });
      searchInput.addEventListener("keydown", (e) => {
        const items = Array.from(resultsEl.querySelectorAll(".search-item"));
        if (!items.length) return;
        if (e.key === "ArrowDown") {
          e.preventDefault();
          activeIndex = (activeIndex + 1) % items.length;
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          activeIndex = (activeIndex - 1 + items.length) % items.length;
        } else if (e.key === "Enter") {
          e.preventDefault();
          if (activeIndex >= 0) {
            const idx = parseInt(items[activeIndex].dataset.idx, 10);
            const item = getRenderedItemByIndex(idx);
            if (item) applyResult(item);
          } else {
            // 沒選中，用第一個
            const first = getRenderedItemByIndex(0);
            if (first) applyResult(first);
          }
        } else if (e.key === "Escape") {
          resultsEl.style.display = "none";
          return;
        } else {
          return; // 其他鍵不處理 active 樣式
        }
        // 更新 active 樣式與可視區域
        items.forEach((el, i) =>
          el.classList.toggle("active", i === activeIndex)
        );
        const activeEl = items[activeIndex];
        if (activeEl) {
          const rBox = resultsEl.getBoundingClientRect();
          const aBox = activeEl.getBoundingClientRect();
          if (aBox.bottom > rBox.bottom) activeEl.scrollIntoView(false);
          if (aBox.top < rBox.top) activeEl.scrollIntoView();
        }
      });
      // 點外面關閉建議
      document.addEventListener("click", (e) => {
        if (!resultsEl.contains(e.target) && e.target !== searchInput) {
          resultsEl.style.display = "none";
        }
      });
      function getRenderedItemByIndex(idx) {
        // 依目前渲染內容重建 item；更穩的方式是把 items 暫存起來
        const q = searchInput.value.trim();
        const parts = q.split(/\s+/);
        const items = SEARCH_INDEX.filter((it) => {
          if (parts.length >= 2) return it.labelFull.includes(q);
          return (
            it.labelFull.includes(q) ||
            it.label.includes(q) ||
            (it.type === "district" && it.county.includes(q))
          );
        }).sort((a, b) => {
          let sa = 0,
            sb = 0;
          if (a.labelFull.includes(q)) sa += 3;
          if (a.type === "district" && a.label.includes(q)) sa += 2;
          if (a.county?.includes(q)) sa += 1;
          if (b.labelFull.includes(q)) sb += 3;
          if (b.type === "district" && b.label.includes(q)) sb += 2;
          if (b.county?.includes(q)) sb += 1;
          return (
            sb - sa ||
            a.labelFull.length - b.labelFull.length ||
            a.labelFull.localeCompare(b.labelFull)
          );
        });
        return items[idx];
      }

      // Decide pin color by stock
      function colorByStock(stockRaw) {
        const n = Number.parseInt(String(stockRaw ?? "").trim(), 10);
        if (Number.isNaN(n)) return "blue";
        if (n === 0) return "red";
        if (n < 10) return "yellow";
        return "blue";
      }

      // Popup HTML helper
      function createPopupHTML(item) {
        const name = item.name ?? "未命名";
        const address =
          item.address ??
          item.address_info?.candidates?.[0]?.address ??
          "（無地址）";
        const stock = item.stock ?? "未知";
        const soldout = item.is_soldout === true ? "（已售罄）" : "";
        const selling = (item.is_selling ?? "").toString();
        return `
        <div>
          <div class="popup-title">${name}${
          item.retrieved_at
            ? `<span class="popup-retrieve-time">(資料抓取時間：${new Date(
                item.retrieved_at * 1000
              ).toLocaleString()})</span>`
            : ""
        }</div>
          <p class="popup-desc">地址：${address}</p>
          <p class="popup-desc">庫存（HIV 自我篩檢）：<strong>${stock}</strong> ${soldout}</p>
          ${selling ? `<p class="popup-desc">販售：${selling}</p>` : ""}
          ${
            item.telephone
              ? `<p class="popup-desc">電話：${item.telephone}</p>`
              : ""
          }
          ${
            item.service_time
              ? `<p class="popup-desc">服務時間：${item.service_time}</p>`
              : ""
          }
        </div>
        `;
      }

      // Load markers from selftester.json (x -> lng, y -> lat)
      fetch("/data/selftester.json")
        .then((r) => r.json())
        .then((data) => {
          const markers = [];
          (data || []).forEach((item) => {
            if (!item.geo_point) return;
            const [lat, lng] = item.geo_point;
            const color = colorByStock(item.stock);
            const marker = L.marker([lat, lng], { icon: ICONS[color] }).addTo(map);
            marker.bindPopup(createPopupHTML(item));
            markers.push(marker);
          });

          if (markers.length) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.15));
          } else {
            console.warn("No valid marker locations found in selftester.json");
          }
        })
        .catch((err) => console.error("Failed to load selftester.json:", err));

      // ===== Browser Geolocation API + Leaflet fallback =====

      function showUserLocation(latlng) {
        map.flyTo(latlng, Math.max(map.getZoom(), 13));
      }

      async function locateWithBrowserAPI() {
        if (!("geolocation" in navigator)) {
          throw new Error("Geolocation is not supported by this browser.");
        }
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const { latitude, longitude, accuracy } = pos.coords;
              resolve({ lat: latitude, lng: longitude, accuracy });
            },
            (err) => reject(err),
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        });
      }

      async function locateUser(showAlertOnError = true) {
        const btn = document.getElementById("locateBtn");
        const btnText = document.getElementById("locateBtnText");
        btn.disabled = true;
        btnText.textContent = "定位中…";
        try {
          // Try Browser Geolocation API first
          const res = await locateWithBrowserAPI();
          showUserLocation([res.lat, res.lng]);
        } catch (e) {
          console.warn("Browser geolocation failed:", e?.message || e);
          // Fallback to Leaflet locate (also uses browser API but through Leaflet)
          map.once("locationfound", (ev) => {
            showUserLocation(ev.latlng);
          });
          map.once("locationerror", (ev) => {
            console.warn(
              "Unable to determine your location: ",
              ev?.message || ev
            );
            if (showAlertOnError)
              alert("無法抓取到你的位置，請確定位置權限是否開啟。");
          });
          map.locate({
            setView: false,
            maxZoom: 13,
            enableHighAccuracy: true,
            timeout: 10000,
          });
        } finally {
          btn.disabled = false;
          btnText.textContent = "移到我的位置";
        }
      }

      document
        .getElementById("locateBtn")
        .addEventListener("click", locateUser);
      setTimeout(() => locateUser(false), 1000); // Auto-locate after 1 second

      // ===== 行政區選單 =====
      async function loadRegions() {
        try {
          const r = await fetch("/data/tw-region.json", { cache: "no-store" });
          if (!r.ok) throw new Error("tw-region.json not found");
          REGIONS = await r.json();
        } catch (e) {
          console.warn("Failed to load tw-region.json:", e?.message || e);
          REGIONS = [];
        }
        fillCountyOptions();
        buildSearchIndex();
      }
      loadRegions();
    </script>
  </body>
</html>
